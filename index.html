<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Habitus |Build Flow Tool for Docker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css?v=2" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
Date();a=s.createElement(o),

m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a
,m)

})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-25691976-10', 'auto');
ga('send', 'pageview');
</script>
  </head>
  <body>
    <section class="page-header">
      <img src="./images/habitus.svg" width="100"/>
      <h1 class="project-name">Habitus</h1>
      <h2 class="project-tagline">A Build Flow Tool for Docker</h2>
      <a href="https://github.com/cloud66/habitus/releases?utm_source=Githubdownload&utm_medium=GHDpage&utm_campaign=habitus" target="_blank" class="btn">Download Habitus</a>

      <a href="https://github.com/cloud66/habitus" target="_blank" class="btn" >View on GitHub</a>
      <p class="logo"><a href="http://www.cloud66.com/?utm_source=Hpage&utm_medium=Hpage&utm_campaign=Habitus"><img src="images/C66white.png" width="40" /></a> </p>
      <p class = "logotext">Habitus is maintained by Cloud 66</p>
    </section>

    <section class="main-content">
      <h3>
<a id="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages" aria-hidden="true"><span class="octicon octicon-link"></span></a>Welcome to Habitus</h3>
<p>Habitus is a standalone build flow tool for Docker. It is a command line tool that builds Docker images based on their <code>Dockerfile</code> and a <code>build.yml</code>.</p>

<p class="YouTube">
<iframe width="560" height="315" src="https://www.youtube.com/embed/U_UblOAROlI" frameborder="0" allowfullscreen></iframe></p>

<h4>Build files</h4>
<p>Habitus uses a yml file as a descriptor for builds. Here is an example:</p>

<pre class="yaml">
  <code>
build:
  version: 2016-03-14 # version of the build schema.
  steps:
    builder:
      name: builder
      dockerfile: Dockerfile.builder
      secrets:
        id_rsa:
          type: file
          value: _env(HOME)/.ssh/my_private_key
      artifacts:
        - /go/src/github.com/cloud66/iron-mountain/iron-mountain
        - /go/src/github.com/cloud66/iron-mountain/config.json
        - /go/src/github.com/cloud66/iron-mountain/localhost.crt
        - /go/src/github.com/cloud66/iron-mountain/localhost.key
      cleanup:
        commands:
          - rm -rf /root/.ssh/
    deployment:
      name: ironmountain
      dockerfile: Dockerfile.deployment
      depends_on:
        - builder
    uploader:
      name: uploader
      dockerfile: Dockerfile.uploader
      depends_on:
        - ironmountain
      command: s3cmd --access_key=_env(ACCESS_KEY) --secret_key=_env(SECRET_KEY) put /app/iron-mountain s3://uploads.aws.com
  </code>
</pre>

<p>Build files can be made up of multiple steps. Each step is independent of the other ones and downstream steps can use upstream ones as source (in <code>FROM</code> command).</p>
<p>In the example above, there are three steps: <code>builder</code>, <code>deployment</code> and <code>uploader</code>. All steps work out of the same working directory. <code>dockerfile</code> states which Dockerfile is used to build this step.</p>

<p>Here is a list of all step elements:</p>

<ul>
<li><code>name:</code> Name of the generated image</li>
<li><code>dockerfile:</code> Dockerfile used to build the step</li>
<li><code>artifacts:</code> List of all files to be copied out of the image once it's built. See below</li>
<li><code>secrets:</code> List of all secrets available to the build process. See below</li>
<li><code>cleanup:</code> List of all cleanup steps to run on the image once the step is finished. See below</li>
<li><code>depends_on:</code>Lists all the steps this step depends on (and should be built prior to this step's build)</li>
<li><code>command:</code>A command that will run in the running container after it's built</li>
</ul>

<h4>Artifacts</h4>
<p>Artifacts are files to be copied outside of a build image in a step. This can be used when a step is build of a compiled language like Go or Java where the image requires build dependencies. The next step can then use the build step's artifacts in a runtime dependency only image.</p>
<p>Each artefact has two parts: source and destination. Source is the path from within the image and destination where the file will be copied to on the "build server". If destination is missing, the current folder will be used. Full path and file permissions of the source will be preserved during copy. So a file that comes from <code>/app/build/result/abc</code> of the image will go to <code>./app/build/result/abc</code> of the build server if no destination is set.</p>

<p>Here is an example:</p>

<p>
<code>
- /go/src/service/go-service
</code>
</p>

<p>or</p>

<p>
  <code>- /go/src/service/go-service:/tmp/go-service</code>
</p>

<p>Artifacts are copied from the container and can be used with <code>ADD</code> or <code>COPY</code> commands in downstream steps. Habitus copies artefact file permissions as well.</p>

<p>Here is an example that uses an artefact generated in step <code>builder</code></p>

<pre>
  <code>
    FROM ubuntu
    ADD ./iron-mountain /app/iron-mountain
  </code>
</pre>

<h4>Secrets</h4>
<p>Managing secrets during a Docker build is tricky. You have might need to clone a private git repository as part of your build process and will need to have your private SSH key in the image before that. But that's not a good idea. Here is why:</p>
<p>First of all, you will need to copy your private SSH key to your build context, moving it out of your home directory and leaving it exposed to accidental commits to your Git repo.</p>
<p>Secondly you will end up with the key in the image (unless you use the <code>cleanup</code> step with Habitus, see below). Which will be in the image forever.</p>
<p>Third issue is that you will end up sharing SSH keys even if you decided to take the risk and add SSH keys to the image but squash them later.</p>

<p>Habits can help you in this case by using <code>secrets</code></p>
<p>Habitus has an internal web server. This webserver only serves to requests comming from inside of the building containers. Building containers can ask for "secrets" during build with a simple <code>wget</code> or <code>curl</code>. The secret is delivered to the build process which can be used and removed in the same layer leaving no trace in the image.</p>
<p>Here is an example:</p>

<pre>
  <code>
    # Optional steps to take care of git and Github protocol and server fingerprint issues
    RUN git config --global url."git@github.com:".insteadOf "https://github.com/"
    RUN ssh-keyscan -H github.com >> ~/.ssh/known_hosts

    # using Secrets
    ARG host
    RUN wget -O ~/.ssh/id_rsa http://$host:8080/v1/secrets/file/id_rsa && chmod 0600 ~/.ssh/id_rsa && ssh -T git@github.com && rm ~/.ssh/id_rsa
  </code>
</pre>

<p>This is a snippet from a sample Dockerfile that uses the <code>secrets</code> feature of Habitus.</p>
<p>First, we make sure all git requests to Github go through the git protocol rather than HTTP (this is optional)</p>
<p>Second, we are going to add Github's server fingerprint to our <code>known_hosts</code> file to avoid the "yes/no" prompt</p>
<p>Now we can use Habitus and pull our private SSH key as a secret. It will be stored in <code>~/.ssh/id_rsa</code> and the next commands will use it (<code>ssh -T git@github.com</code> is a test that it worked) and the last step (very important) is removing it from the image with no traces and no need to use <code>cleanup</code>.</p>

<p>You notice that here we are using the Build Arguments in the Dockerfile with <code>ARG</code>. This allows us to pass in the Habitus IP address into the container without saving it into the image. You can pass in Build Arguments into Habitus with <code>--build</code> parameter:</p>

<p><kbd>$ habitus --build host=192.168.99.1</kbd></p>

<h5>Secret configuration</h5>

<p><b>IMPORTANT</b>: Secrets are supported in Habitus 0.4 onward and only with <code>build.yml</code> schema versions on or more recent than <code>2016-03-14</code>.</p>

<p>You can define as many secrets for your build. Each secret has 3 attributes:</p>

<ul>
  <li>Name: Name is what the build will refer to this secret as. In this example the name is <code>id_rsa</code></li>
  <li>Type: Currently only <code>file</code> is supported as <code>type</code> which means Habitus only supports secrets stored in a file.</li>
  <li>Value: Value depends on the <code>type</code>. For <code>file</code>, <code>value</code> is the path to the file holding the secret on the build host (ie. your laptop or build server).</li>
</ul>

<pre>
  <code>
secrets:
        id_rsa:
          type: file
          value: _env(HOME)/.ssh/my_private_key
  </code>
</pre>


<h5>Habitus IP address</h5>
<p>Finding the correct IP address to server Habitus API (and secrets) on can be tricky. You don't want to bind it to <code>0.0.0.0</code> since it will make Habitus and your secrets available to your entire local network (and possibly the internet if you're running a tunnel) during the build time.</p>
<p>On a Linux machine where Docker can run natively you can bind Habitus to <code>127.0.0.1</code>. However on a Mac (OSX) Docker runs inside of a VM (VirtualBox in most cases thorugh Boot2Docker). This means you need to find the VM address of your Mac and use that to bind Habitus to. By default, Boot2Docker (and Docker Machine) use <code>192.168.99.1</code> which is what Habitus uses by default.</p>
<p>You can find your VM address by the following command:</p>
<p><kbd>$ ifconfig -a</kbd></p>

<p>What you are looking for is the <code>inet</code> address of a <code>vboxnet</code> like the following:</p>

<pre>
  <code>
    vboxnet3: flags=8943<UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST> mtu 1500
    	ether 0a:00:27:00:00:03
    	inet 192.168.99.1 netmask 0xffffff00 broadcast 192.168.99.255
  </code>
</pre>

<p>On a Mac, if your VM IP address is different from <code>192.168.99.1</code> you can configure Habitus using the <code>--binding</code> parameter:</p>

<p><kbd>$ habitus --binding 10.0.99.1</kbd></p>

<p>You can also change the Habitus API port from the default <code>8080</code> using the <code>--port</code> parameter.</p>

<h4>Cleanup</h4>

<p>Cleanup is a step that runs after the build is finished for a step. At the moment, cleanup is limited to commands:</p>

<pre>
  <code>
cleanup:
  commands:
    - apt-get purge -y man  perl-modules vim-common vim-tiny libpython3.4-stdlib:amd64 python3.4-minimal xkb-data libx11-data eject python3 locales golang-go
    - apt-get clean autoclean
    - apt-get autoremove -y
    - rm -rf /var/lib/{apt,dpkg,cache,log}/
</code>
</pre>

<p>This runs the commands in the provided order on the image and then as a last step squashes the image to remove anything that's been removed. This is particularly useful when it comes to private information like ssh private keys that need to be on the image during the build (to pull git repos for example) but can't be published as part of the built image.</p>

<h4>Image sequencing</h4>

<p>Habitus allows dovetailing (sequencing) of images from different steps. This means a step can use the image built by the previous step as the source in its Dockerfile <code>FROM</code> command. This is done automatically if <code>FROM</code> command refers to an image name used by a previous step.</p>
<p>Habitus automatically parses the <code>FROM</code> image name and replaces it with the correct name when it is used in multi-tenanted setup. This enables multiple builds of the same build file to run in parallel with different session UIDs (see below).</p>

<p>Please note if you are using step A's result in step B's <code>FROM</code> statement, you need to make sure A is listed under <code>depends_on</code> attribute of B. Otherwise both A and B will be built in parallel.</p>

<h4>Step dependencies</h4>

<p>Steps can depend on each other. This can be specified by the <code>depends_on</code> attribute.</p>

<p>Steps can depend on one or more of the other steps. This will determine the build order for steps. Independent steps are built in parallel and according to the build order defined by dependencies.</p>

<h4>Environment variables</h4>
<p>Environment variables can be used in the build file with the <code>_env(VAR)</code> format:</p>

<pre>
  <code>
artifacts:
      - /go/src/go-service/_env(SERVICE_NAME)
  </code>
</pre>


<p>This will be replaced before the build file is fed into the build engine. By default Habitus inherits all environment variables of its parent process. This can be overridden by passing environment variables into Habitus explicitly through the env command parameter:</p>

<p><kbd>$ habitus -env SERVICE_NAME=abc -env RAILS_ENV=production</kbd></p>

<p>In the example above, you can pass in AWS S3 key and secret like this:</p>

<p><kbd>$ habitus -env ACCESS_KEY=$ACCESS_KEY -env SECRET_KEY=$SECRET_KEY</kbd></p>

<h4>Running commands</h4>

<p>Habitus allows you to run an arbitary command inside of a built container. This can be useful in many cases like uploading the build artifacts to webserver, resetting your exception handling service after each build or starting your release process.</p>

<p><code>command</code> attribute is optional. If present, the image is built and a container is started based on it to run the command.</p>

<p><code>command</code> runs after the build, cleanup and copying of the artifacts are done.</p>

<p>An example to upload a build artefact to S3 can be like this</p>

<pre>
  <code>
    FROM cloud66/uploader
    ADD ./iron-mountain /app/iron-mountain
  </code>
</pre>

<p><code><a href="https://hub.docker.com/r/cloud66/uploader/">cloud66/uploader</a></code> is a simple Docker image that has <a href="http://s3tools.org/s3cmd">S3CMD</a> installed on it. </p>

<p>The Dockerfile here is a simple one that starts from <code>cloud66/uploader</code> and adds one of the build artifacts to the image so it can be uploaded to S3.</p>

<h4>Command line parameters</h4>
<p>Habitus accepts the following command line parameters:</p>

<ul>
<li><code>f</code>: Path to the build file. If not specified, it will default to <code>build.yml</code> in the work directory.</li>
<li><code>d</code>: Path to work directory. This is the path where Dockerfiles should exist for each step and the build happens. Defaults to the current directory.</li>
<li><code>binding</code>: IP address to bind Habitus API to. Habitus API provides services like secrets to the building containers. Default is <code>192.168.99.1</code></li>
<li><code>build</code>: Dockerfile Build Arguments passed into the build process</li>
<li><code>certs</code>: Path of the key and cert files used to connect to the Docker daemon. Defaults to <code>$DOCKER_CERT_PATH</code></li>
<li><code>env</code>: Environment variables used in the build process. If not specified Habitus inherits all environment variables of the parent process.</li>
<li><code>force-rm</code>: Forcefully remove intermediate images.</li>
<li><code>force-rmi</code>: Forces removal of unwanted images after the build</li>
<li><code>host</code>: Address for Docker daemon to run the build. Defaults to the value of <code>$DOCKER_HOST</code>.</li>
<li><code>keep-all</code>: Overrides the keep flag for all steps so you can inspect and debug the created images of each step without changing the build file.</li>
<li><code>level</code>: Logging level. Acceptable values: <code>debug</code>, <code>info</code>, <code>notice</code>, <code>warning</code>, <code>error</code> and critical. Defaults to <code>debug</code></li>
<li><code>no-cache</code>: Don't use docker build caching.</li>
<li><code>no-cleanup</code>: Don't run cleanup commands. This can be used for debugging and removes the need to run as sudo</li>
<li><code>noprune-rmi</code>: Doesn't prune unwanted images after the build</li>
<li><code>port</code>: Port to server Habitus API on. Default is <code>8080</code></li>
<li><code>rm</code>: Remove intermediate built images.</li>
<li><code>sec-providers</code>: Comma separated list of secret provider types available during the build. Default is <code>file</code></li>
<li><code>secrets</code>: Enable or disable support for secrets during build. Default is <code>true</code></li>
<li><code>suppress</code>: Suppress docker build output.</li>
<li><code>tls</code>: Use TLS to connect to the Docker daemon (default is true)</li>
<li><code>uid</code>: A unique ID used for a build session to allow multi-tenancy of Habitus</li>
</ul>

<h4>Development Environment for Habitus</h4>

<p>Habitus requires running in privileged more (sudo) so it can run the squash method (keeping file permissions across images). It also requires the following environment variables: <code>DOCKER_HOST</code> and <code>DOCKER_CERT_PATH</code>. These are usually available when Docker is running on a machine, but might not be available in sudo mode. To fix this, you can pass them into the app with commandline params:</p>

<p><kbd>$ sudo habitus --host $DOCKER_HOST --certs $DOCKER_CERT_PATH</kbd></p>

<h4>Dependencies</h4>

<p>You would also need <a href="https://www.gnu.org/software/tar/">gnu tar</a> to be available on the machine:</p>

<h5>OSX<h5>

<p><a href="https://github.com/cloud66/habitus/blob/gh-pages/gnu-tar.md">Instructions for OSX</a></p>

<h4>Multi-tenancy for Habitus</h4>
<p>Habitus supports multi-tenancy of builds by using a <code>uid</code> parameter.</p>
<p>All builds and images will be tagged with the <code>uid</code> for this unless a step name explicitly has a tag. In that case the tag is concatenated with the <code>-uid</code>.</p>






 <p class="call-to-action">
<a href="https://github.com/cloud66/habitus/releases?utm_source=Githubdownload&utm_medium=GHDpage&utm_campaign=habitus" class="btn1" >Download Habitus</a>

<a href="https://cloud66ers.slack.com/messages/habitus" class="btn1" >Discuss on Slack</a>
<a href="http://blog.cloud66.com/tag/habitus/" class="btn1" >Read more &rarr;</a>
</p>


<footer class="site-footer">
  <span class="site-footer-owner">



</footer>

</section>
<!-- Social Media Share buttons-->
<!-- LinkedIn -->
<div class="socialbuttons">
 <a class="socialbutton" href="http://www.linkedin.com/shareArticle?url=http://www.habitus.io" target="_blank">
  <i class="fa fa-linkedin"></i>
 </a>

<!-- Reddit -->
  <a class="socialbutton" href="http://reddit.com/submit?url=http://www.habitus.io/&amp;title=Habitus: an open source Docker build flow tool" target="_blank">
   <i class="fa fa-reddit-alien"></i>
  </a>

<!-- Twitter -->
  <a class="socialbutton" href="https://twitter.com/share?url=http://www.habitus.io/&amp;text=Habitus: an open source Docker build flow tool by Cloud 66 &amp;hashtags=Habitus,Dockerfile" target="_blank">
   <i class="fa fa-twitter"></i>
  </a>

<!-- Hacker News -->
  <a class="socialbutton" href="https://news.ycombinator.com/submitlink?u=http://habitus.io&t=Habitus%20:%20an%20open%20source%20Docker%20build%20flow%20tool%20" target="_blank">
    <i class="fa fa-hacker-news"></i>
  </a>

<!--Slack Habitus Community -->
 <a class="socialbutton" href="https://cloud66ers.slack.com/messages/habitus">
  <i class="fa fa-slack"></i>
 </a>

 <!--Slack Habitus Community -->
 <a class="socialbutton" href="https://www.youtube.com/embed/knIdorbr5L8">
  <i class="fa fa-youtube"></i>
 </a>

</div>



  </body>
</html>
